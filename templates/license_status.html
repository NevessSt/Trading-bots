{% extends "base.html" %}

{% block title %}License Status - Trading Bot{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-certificate mr-2"></i>
                        License Status
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-box {% if license_info.valid %}bg-success{% else %}bg-danger{% endif %}">
                                <span class="info-box-icon">
                                    <i class="fas {% if license_info.valid %}fa-check-circle{% else %}fa-times-circle{% endif %}"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">License Status</span>
                                    <span class="info-box-number">
                                        {% if license_info.valid %}
                                            Valid
                                        {% else %}
                                            Invalid
                                        {% endif %}
                                    </span>
                                    <span class="info-box-more">{{ license_info.message }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="info-box bg-info">
                                <span class="info-box-icon">
                                    <i class="fas fa-tag"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">License Type</span>
                                    <span class="info-box-number">{{ license_info.license_type|title }}</span>
                                    {% if license_info.days_remaining is defined %}
                                        <span class="info-box-more">{{ license_info.days_remaining }} days remaining</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if license_info.expiry_date and license_info.expiry_date != 'N/A' %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert {% if license_info.days_remaining > 30 %}alert-success{% elif license_info.days_remaining > 7 %}alert-warning{% else %}alert-danger{% endif %}">
                                <h5><i class="fas fa-calendar-alt"></i> Expiry Information</h5>
                                <p><strong>Expires:</strong> {{ license_info.expiry_date }}</p>
                                {% if license_info.days_remaining is defined %}
                                    <p><strong>Days Remaining:</strong> {{ license_info.days_remaining }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if license_info.features %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-list"></i> Available Features</h5>
                            <div class="row">
                                {% for feature in license_info.features %}
                                <div class="col-md-4 col-sm-6">
                                    <div class="feature-item mb-2">
                                        <i class="fas fa-check text-success"></i>
                                        <span class="ml-2">{{ feature|replace('_', ' ')|title }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not license_info.valid %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> License Invalid</h4>
                        <p>{{ license_info.message }}</p>
                        <hr>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <a href="{{ url_for('activate_license') }}" class="btn btn-primary">
                                <i class="fas fa-key"></i> Activate License
                            </a>
                            <button class="btn btn-outline-info" onclick="showMachineId()">
                                <i class="fas fa-desktop"></i> Show Machine ID
                            </button>
                        </div>
                        <div id="machineIdInfo" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Your Machine ID:</strong> <code id="machineId">Loading...</code><br>
                                <small>Provide this ID when purchasing a license</small>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="refreshLicenseStatus()">
                                    <i class="fas fa-sync-alt"></i> Refresh Status
                                </button>
                                {% if current_user.is_authenticated %}
                                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.feature-item {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.feature-item:last-child {
    border-bottom: none;
}

.info-box {
    border-radius: 10px;
    margin-bottom: 20px;
}

.info-box-icon {
    border-radius: 10px 0 0 10px;
}

.alert {
    border-radius: 10px;
}
</style>

<script>
function refreshLicenseStatus() {
    // Show loading state
    const refreshBtn = document.querySelector('button[onclick="refreshLicenseStatus()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Refresh the page after a short delay
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function showMachineId() {
    const machineIdDiv = document.getElementById('machineIdInfo');
    const machineIdSpan = document.getElementById('machineId');
    
    if (machineIdDiv.style.display === 'none') {
        machineIdDiv.style.display = 'block';
        
        // Fetch machine ID from API
        fetch('/api/machine-id')
            .then(response => response.json())
            .then(data => {
                if (data.machine_id) {
                    machineIdSpan.textContent = data.machine_id;
                } else {
                    machineIdSpan.textContent = 'Error loading machine ID';
                }
            })
            .catch(error => {
                machineIdSpan.textContent = 'Error loading machine ID';
            });
    } else {
        machineIdDiv.style.display = 'none';
    }
}

// Auto-refresh every 5 minutes
setInterval(() => {
    fetch('/api/license-status')
        .then(response => response.json())
        .then(data => {
            if (!data.valid) {
                // If license becomes invalid, refresh the page
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error checking license status:', error);
        });
}, 300000); // 5 minutes
</script>
{% endblock %}