{% extends "base.html" %}

{% block title %}Performance - TradingBot Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="fas fa-chart-bar me-2 text-primary"></i>Performance Analytics
    </h2>
    <div class="btn-group">
        <button class="btn btn-outline-primary active" data-period="7d">7 Days</button>
        <button class="btn btn-outline-primary" data-period="30d">30 Days</button>
        <button class="btn btn-outline-primary" data-period="90d">90 Days</button>
        <button class="btn btn-outline-primary" data-period="1y">1 Year</button>
    </div>
</div>

<!-- Performance Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total Trades</h6>
                        <h3 class="card-title mb-0">{{ total_trades }}</h3>
                        <small class="text-success"><i class="fas fa-arrow-up"></i> +12 this week</small>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-exchange-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card {{ 'success' if win_rate >= 50 else 'warning' }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Win Rate</h6>
                        <h3 class="card-title mb-0">{{ "{:.1f}%".format(win_rate) }}</h3>
                        <small class="{{ 'text-success' if win_rate >= 50 else 'text-warning' }}">
                            <i class="fas {{ 'fa-arrow-up' if win_rate >= 50 else 'fa-arrow-down' }}"></i> 
                            {{ "Above" if win_rate >= 50 else "Below" }} average
                        </small>
                    </div>
                    <div class="{{ 'text-success' if win_rate >= 50 else 'text-warning' }}">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card {{ 'success' if total_profit >= 0 else 'danger' }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Total P&L</h6>
                        <h3 class="card-title mb-0 {{ 'profit-positive' if total_profit >= 0 else 'profit-negative' }}">
                            {{ "${:,.2f}".format(total_profit) }}
                        </h3>
                        <small class="{{ 'text-success' if total_profit >= 0 else 'text-danger' }}">
                            <i class="fas {{ 'fa-arrow-up' if total_profit >= 0 else 'fa-arrow-down' }}"></i> 
                            {{ "{:.1f}%".format((total_profit / 10000) * 100) }} ROI
                        </small>
                    </div>
                    <div class="{{ 'text-success' if total_profit >= 0 else 'text-danger' }}">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Avg Trade Size</h6>
                        <h3 class="card-title mb-0" id="avgTradeSize">$0</h3>
                        <small class="text-muted">Per transaction</small>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Portfolio Performance
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" data-chart="cumulative">Cumulative</button>
                    <button class="btn btn-outline-primary" data-chart="daily">Daily P&L</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Trade Outcomes
                </h5>
            </div>
            <div class="card-body">
                <canvas id="outcomeChart"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-success"><i class="fas fa-circle me-1"></i>Winning Trades</span>
                        <span id="winningCount">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-danger"><i class="fas fa-circle me-1"></i>Losing Trades</span>
                        <span id="losingCount">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-secondary"><i class="fas fa-circle me-1"></i>Break-even</span>
                        <span id="breakEvenCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Analytics -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Monthly Performance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="120"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-coins me-2"></i>Top Trading Pairs
                </h5>
            </div>
            <div class="card-body">
                <canvas id="pairsChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Performance Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Detailed Performance Metrics
        </h5>
        <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
            <i class="fas fa-download me-2"></i>Export CSV
        </button>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="border rounded p-3 text-center">
                    <h6 class="text-muted mb-1">Best Day</h6>
                    <h4 class="text-success mb-0" id="bestDay">+$0</h4>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="border rounded p-3 text-center">
                    <h6 class="text-muted mb-1">Worst Day</h6>
                    <h4 class="text-danger mb-0" id="worstDay">-$0</h4>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="border rounded p-3 text-center">
                    <h6 class="text-muted mb-1">Avg Daily P&L</h6>
                    <h4 class="mb-0" id="avgDaily">$0</h4>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="border rounded p-3 text-center">
                    <h6 class="text-muted mb-1">Sharpe Ratio</h6>
                    <h4 class="mb-0" id="sharpeRatio">0.00</h4>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="performanceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Trades</th>
                        <th>Win Rate</th>
                        <th>Daily P&L</th>
                        <th>Cumulative P&L</th>
                        <th>Volume</th>
                        <th>Best Trade</th>
                        <th>Worst Trade</th>
                    </tr>
                </thead>
                <tbody id="performanceTableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let performanceChart, outcomeChart, monthlyChart, pairsChart;
    let currentPeriod = '7d';
    let currentChartType = 'cumulative';
    
    // Initialize charts
    initializeCharts();
    loadPerformanceData();
    
    // Period selection
    $('[data-period]').click(function() {
        $('[data-period]').removeClass('active');
        $(this).addClass('active');
        currentPeriod = $(this).data('period');
        loadPerformanceData();
    });
    
    // Chart type selection
    $('[data-chart]').click(function() {
        $('[data-chart]').removeClass('active');
        $(this).addClass('active');
        currentChartType = $(this).data('chart');
        updatePerformanceChart();
    });
    
    function initializeCharts() {
        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Portfolio Value',
                    data: [],
                    borderColor: 'rgb(37, 99, 235)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Outcome Chart
        const outcomeCtx = document.getElementById('outcomeChart').getContext('2d');
        outcomeChart = new Chart(outcomeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Winning', 'Losing', 'Break-even'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgb(16, 185, 129)',
                        'rgb(239, 68, 68)',
                        'rgb(107, 114, 128)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Monthly Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        monthlyChart = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Monthly P&L',
                    data: [],
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
                    },
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Trading Pairs Chart
        const pairsCtx = document.getElementById('pairsChart').getContext('2d');
        pairsChart = new Chart(pairsCtx, {
            type: 'horizontalBar',
            data: {
                labels: [],
                datasets: [{
                    label: 'P&L by Pair',
                    data: [],
                    backgroundColor: 'rgba(37, 99, 235, 0.8)',
                    borderColor: 'rgb(37, 99, 235)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    function loadPerformanceData() {
        // Generate mock data based on period
        const days = getDaysFromPeriod(currentPeriod);
        const dailyData = generateDailyPerformanceData(days);
        
        updatePerformanceChart();
        updateOutcomeChart(dailyData);
        updateMonthlyChart();
        updatePairsChart();
        updateMetrics(dailyData);
        updatePerformanceTable(dailyData);
    }
    
    function getDaysFromPeriod(period) {
        switch(period) {
            case '7d': return 7;
            case '30d': return 30;
            case '90d': return 90;
            case '1y': return 365;
            default: return 30;
        }
    }
    
    function generateDailyPerformanceData(days) {
        const data = [];
        let cumulativeValue = 10000;
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            
            const dailyChange = (Math.random() - 0.45) * 200; // Slight positive bias
            cumulativeValue += dailyChange;
            
            data.push({
                date: date,
                dailyPL: dailyChange,
                cumulativePL: cumulativeValue - 10000,
                cumulativeValue: Math.max(cumulativeValue, 5000),
                trades: Math.floor(Math.random() * 10) + 1,
                volume: Math.random() * 5000 + 1000
            });
        }
        
        return data;
    }
    
    function updatePerformanceChart() {
        const days = getDaysFromPeriod(currentPeriod);
        const data = generateDailyPerformanceData(days);
        
        const labels = data.map(d => d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        const values = currentChartType === 'cumulative' 
            ? data.map(d => d.cumulativeValue)
            : data.map(d => d.dailyPL);
        
        performanceChart.data.labels = labels;
        performanceChart.data.datasets[0].data = values;
        performanceChart.data.datasets[0].label = currentChartType === 'cumulative' ? 'Portfolio Value' : 'Daily P&L';
        
        if (currentChartType === 'daily') {
            performanceChart.data.datasets[0].backgroundColor = function(context) {
                const value = context.parsed.y;
                return value >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
            };
            performanceChart.data.datasets[0].borderColor = function(context) {
                const value = context.parsed.y;
                return value >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)';
            };
        } else {
            performanceChart.data.datasets[0].backgroundColor = 'rgba(37, 99, 235, 0.1)';
            performanceChart.data.datasets[0].borderColor = 'rgb(37, 99, 235)';
        }
        
        performanceChart.update();
    }
    
    function updateOutcomeChart(data) {
        const totalTrades = {{ total_trades }};
        const winningTrades = Math.floor(totalTrades * ({{ win_rate }} / 100));
        const losingTrades = totalTrades - winningTrades;
        const breakEvenTrades = Math.floor(totalTrades * 0.05); // 5% break-even
        
        outcomeChart.data.datasets[0].data = [winningTrades, losingTrades, breakEvenTrades];
        outcomeChart.update();
        
        $('#winningCount').text(winningTrades);
        $('#losingCount').text(losingTrades);
        $('#breakEvenCount').text(breakEvenTrades);
    }
    
    function updateMonthlyChart() {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        const monthlyPL = months.map(() => (Math.random() - 0.3) * 1000);
        
        monthlyChart.data.labels = months;
        monthlyChart.data.datasets[0].data = monthlyPL;
        monthlyChart.update();
    }
    
    function updatePairsChart() {
        const pairs = ['BTCUSDT', 'ETHUSDT', 'ADAUSDT', 'DOTUSDT', 'LINKUSDT'];
        const pairsPL = pairs.map(() => (Math.random() - 0.4) * 500);
        
        pairsChart.data.labels = pairs;
        pairsChart.data.datasets[0].data = pairsPL;
        pairsChart.update();
    }
    
    function updateMetrics(data) {
        const totalVolume = data.reduce((sum, d) => sum + d.volume, 0);
        const avgTradeSize = totalVolume / {{ total_trades if total_trades > 0 else 1 }};
        
        const dailyPLs = data.map(d => d.dailyPL);
        const bestDay = Math.max(...dailyPLs);
        const worstDay = Math.min(...dailyPLs);
        const avgDaily = dailyPLs.reduce((sum, pl) => sum + pl, 0) / dailyPLs.length;
        
        const stdDev = Math.sqrt(dailyPLs.reduce((sum, pl) => sum + Math.pow(pl - avgDaily, 2), 0) / dailyPLs.length);
        const sharpeRatio = stdDev > 0 ? (avgDaily / stdDev) : 0;
        
        $('#avgTradeSize').text('$' + avgTradeSize.toLocaleString(undefined, {maximumFractionDigits: 0}));
        $('#bestDay').text('+$' + bestDay.toLocaleString(undefined, {maximumFractionDigits: 2}));
        $('#worstDay').text('-$' + Math.abs(worstDay).toLocaleString(undefined, {maximumFractionDigits: 2}));
        $('#avgDaily').text((avgDaily >= 0 ? '+' : '') + '$' + avgDaily.toLocaleString(undefined, {maximumFractionDigits: 2}));
        $('#sharpeRatio').text(sharpeRatio.toFixed(2));
    }
    
    function updatePerformanceTable(data) {
        const tbody = $('#performanceTableBody');
        tbody.empty();
        
        data.slice(-10).reverse().forEach(d => {
            const winRate = Math.random() * 100;
            const bestTrade = Math.random() * 100;
            const worstTrade = -Math.random() * 50;
            
            const row = `
                <tr>
                    <td>${d.date.toLocaleDateString()}</td>
                    <td>${d.trades}</td>
                    <td>${winRate.toFixed(1)}%</td>
                    <td class="${d.dailyPL >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${(d.dailyPL >= 0 ? '+' : '')}$${d.dailyPL.toLocaleString(undefined, {maximumFractionDigits: 2})}
                    </td>
                    <td class="${d.cumulativePL >= 0 ? 'profit-positive' : 'profit-negative'}">
                        ${(d.cumulativePL >= 0 ? '+' : '')}$${d.cumulativePL.toLocaleString(undefined, {maximumFractionDigits: 2})}
                    </td>
                    <td>$${d.volume.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="profit-positive">+$${bestTrade.toFixed(2)}</td>
                    <td class="profit-negative">$${worstTrade.toFixed(2)}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    window.exportData = function() {
        // Generate CSV data
        const csvData = [
            ['Date', 'Trades', 'Win Rate', 'Daily P&L', 'Cumulative P&L', 'Volume'],
            ...Array.from($('#performanceTableBody tr')).map(row => {
                return Array.from(row.cells).slice(0, 6).map(cell => cell.textContent.trim());
            })
        ];
        
        const csvContent = csvData.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `performance_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        window.URL.revokeObjectURL(url);
        showAlert('Performance data exported successfully!', 'success');
    };
});
</script>
{% endblock %}